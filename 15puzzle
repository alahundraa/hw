#!/usr/bin/env bash
# 15puzzle — Игра в пятнашки (Ubuntu 24.04+, bash 5.2+)
set -euo pipefail

# Ловим Ctrl+C и не выходим, а просто подсказываем пользователю
trap 'echo -e "\nЧтобы выйти, введите q";' INT

# ------------------------------------------------------------------------------
# Функция: gen_board
# Генерирует случайную, но решаемую доску (4x4, 15 костяшек + одно пустое место)
# ------------------------------------------------------------------------------
gen_board() {
  local a=( {1..15} 0 ) i j t inv=0 zr=0
  # Перемешиваем массив чисел (Fisher–Yates shuffle)
  for ((i=${#a[@]}-1;i>0;i--)); do
    j=$((RANDOM%(i+1)))   # случайный индекс
    t=${a[i]}              # меняем местами элементы
    a[i]=${a[j]}
    a[j]=$t
  done

  # Подсчёт инверсий и строки пустой клетки (0)
  for ((i=0;i<16;i++)); do
    ((a[i]==0)) && zr=$((4 - i/4))  # строка пустой клетки снизу
    for ((j=i+1;j<16;j++)); do
      # инверсия — когда более крупная цифра идёт перед меньшей
      ((a[i]>0 && a[j]>0 && a[i]>a[j])) && ((inv++))
    done
  done

  # Решаемость пятнашек: сумма (инверсии + номер строки пустой снизу) должна быть чётной
  (((inv + zr) % 2 == 0)) || { gen_board; return; }  # если нет — генерируем заново
  echo "${a[*]}"
}

# ------------------------------------------------------------------------------
# Функция: draw
# Отображает доску в виде таблицы 4x4 с рамкой и разделителями
# ------------------------------------------------------------------------------
draw() {
  local a=($1) r c v sep="+-------------------+"
  echo "$sep"
  for r in {0..3}; do
    printf "|"
    for c in {0..3}; do
      v=${a[$((r*4+c))]}
      # 0 — это "пустая" ячейка
      if (( v==0 )); then
        printf "    |"
      else
        printf " %2d |" "$v"
      fi
    done
    echo -e "\n|-------------------|" | sed '4s/|-------------------|/'"$sep"'/'
  done
}

# ------------------------------------------------------------------------------
# Функция: neighbors
# Возвращает список чисел, которые можно сдвинуть (соседи пустой ячейки)
# ------------------------------------------------------------------------------
neighbors() {
  local a=($1) i e
  # Находим индекс пустой клетки (0)
  for i in {0..15}; do ((a[i]==0)) && e=$i; done
  local r=$((e/4)) c=$((e%4)) out=() idx
  # Проверяем возможных соседей по 4 направлениям (вверх, вниз, влево, вправо)
  ((r>0)) && idx=$(((r-1)*4+c)) && out+=("${a[idx]}")
  ((r<3)) && idx=$(((r+1)*4+c)) && out+=("${a[idx]}")
  ((c>0)) && idx=$((r*4+c-1)) && out+=("${a[idx]}")
  ((c<3)) && idx=$((r*4+c+1)) && out+=("${a[idx]}")
  echo "${out[*]}"
}

# ------------------------------------------------------------------------------
# Функция: move_tile
# Меняет местами выбранную костяшку и пустую (если они рядом)
# ------------------------------------------------------------------------------
move_tile() {
  local a=($1) sel=$2 i e
  # Находим индекс пустой клетки
  for i in {0..15}; do ((a[i]==0)) && e=$i; done
  local r=$((e/4)) c=$((e%4)) idx
  # Проверяем 4 возможных соседа и ищем тот, где лежит выбранная костяшка
  for idx in $(((r-1>=0? (r-1)*4+c : -1))) $(((r+1<=3? (r+1)*4+c : -1))) \
             $(((c-1>=0? r*4+c-1 : -1))) $(((c+1<=3? r*4+c+1 : -1))); do
    ((idx>=0)) && ((a[idx]==sel)) && { a[e]=$sel; a[idx]=0; echo "${a[*]}"; return 0; }
  done
  return 1
}

# ------------------------------------------------------------------------------
# Функция: is_solved
# Проверяет, собрана ли головоломка (1..15 + пустая в конце)
# ------------------------------------------------------------------------------
is_solved() {
  local a=($1) i
  for ((i=0;i<15;i++)); do ((a[i]==i+1)) || return 1; done
  ((a[15]==0))
}

# ------------------------------------------------------------------------------
# Основная логика игры
# ------------------------------------------------------------------------------
board="$(gen_board)"  # начальное состояние
step=0

while :; do
  step=$((step+1))
  echo -e "Ход № ${step}\n"
  draw "$board"
  echo
  echo -n "Ваш ход (q - выход): "

  # читаем ввод (Ctrl+D или Ctrl+C не убивает скрипт)
  if ! IFS= read -r inp; then echo; step=$((step-1)); continue; fi
  [[ "$inp" == "q" || "$inp" == "Q" ]] && exit 1

  # список допустимых ходов (соседи пустой клетки)
  valids="$(neighbors "$board")"

  # если выбранная костяшка не в списке допустимых — ошибка
  if [[ " $valids " != *" ${inp} "* ]] || ! [[ "$inp" =~ ^[1-9][0-9]?$ ]]; then
    echo -e "\nНеверный ход!"
    echo "Невозможно костяшку ${inp} передвинуть на пустую ячейку."
    echo "Можно выбрать: ${valids//$'\n'/ }"
    echo
    step=$((step-1))
    continue
  fi

  # совершаем ход (меняем местами выбранную и пустую)
  if board_new="$(move_tile "$board" "$inp")"; then
    board="$board_new"
  else
    echo -e "\nНеверный ход!\n"; step=$((step-1)); continue
  fi

  # проверяем, собрана ли головоломка
  if is_solved "$board"; then
    echo -e "Вы собрали головоломку за ${step} ходов.\n"
    draw "$board"
    exit 0
  fi

  echo
done
