#!/usr/bin/env bash

# Добавляет строку вида "Approved <пользователь> <дата>" в начало всех *.txt файлов каталога.
# Использование: addline КАТАЛОГ
# Пример: addline ./docs

set -euo pipefail
# -e : завершиться при первой ошибке.
# -u : считать использование неинициализированной переменной ошибкой.
# -o pipefail : передавать код ошибки из любой команды в конвейере.

err() {
  printf 'addline: %s\n' "$*" >&2
}

usage() {
  err "использование: addline КАТАЛОГ"
  exit 1
}

[[ $# -eq 1 ]] || usage

target_dir=$1

if [[ ! -d $target_dir ]]; then
  err "не каталог: $target_dir"
  exit 1
fi

user_name=$(id -un)

# Включаем nullglob, чтобы шаблон *.txt не оставался литералом, если совпадений нет.
nullglob_was_set=0
if ! shopt -q nullglob; then
  shopt -s nullglob
  nullglob_was_set=1
fi

# Перебираем только файлы верхнего уровня с помощью раскрытия шаблона.
for file_path in "$target_dir"/*.txt; do
  [[ -f $file_path ]] || continue

  tmp_file=$(mktemp "${TMPDIR:-/tmp}/addline.XXXXXX")

  current_date=$(date --iso-8601=seconds)

  {
    printf 'Approved %s %s\n' "$user_name" "$current_date"
    cat "$file_path"
  } >"$tmp_file"

  # Копируем метаданные исходного файла в заготовку.
  chmod --reference="$file_path" "$tmp_file" 2>/dev/null || true
  chown --reference="$file_path" "$tmp_file" 2>/dev/null || true
  touch --reference="$file_path" "$tmp_file" 2>/dev/null || true

  mv -- "$tmp_file" "$file_path"
done

if [[ $nullglob_was_set -eq 1 ]]; then
  shopt -u nullglob
fi
